<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>incrustwerush.org | News & Article</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
<style>
.news-card img{max-width:100%;height:auto}
.news-card{display:flex;gap:12px;align-items:flex-start}
.news-thumb{width:150px;height:100px;object-fit:cover;object-position:center;border-radius:4px}
@media(max-width:576px){.news-card{flex-direction:column}.news-thumb{width:100%;height:200px}}
html{word-wrap:break-word}
.cke_notification {
    display: none !important;
}

</style>
</head>
<body class="p-4">

<h3 class="mb-4">Management News & Article</h3>

<div class="mb-4">
  <input id="title" placeholder="Judul" class="form-control mb-2">
  <textarea id="content" placeholder="Konten" class="form-control mb-2" rows="10"></textarea>
  <input id="tags" placeholder="Tag (pisahkan koma)" class="form-control mb-2">
  <input id="image_url" placeholder="URL Gambar" class="form-control mb-2">
  <button class="btn btn-success w-100" onclick="createNews()">Tambah Berita</button>
</div>

<div id="news-list"></div>
<div id="pagination" class="mt-3"></div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5 class="modal-title mb-3">Login</h5>
      <input id="email" placeholder="Email" class="form-control mb-2">
      <input id="password" placeholder="Password" type="password" class="form-control mb-2">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <h5 class="modal-title mb-3">Edit Berita</h5>
      <input id="edit_title" class="form-control mb-2" placeholder="Judul">
      <textarea id="edit_content" class="form-control mb-2" rows="10" placeholder="Konten"></textarea>
      <input id="edit_tags" class="form-control mb-2" placeholder="Tags (pisahkan koma)">
      <input id="edit_image_url" class="form-control mb-2" placeholder="URL Gambar">
      <div class="text-end">
        <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" onclick="saveEdit()">Simpan</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BASE_URL="https://second.incrustwerush.org"
let token=localStorage.getItem("jwt_token")||""
let editingId=null

document.addEventListener("DOMContentLoaded",async()=>{
  CKEDITOR.replace('content',{height:300})
  CKEDITOR.replace('edit_content',{height:300})
  const loginModal=new bootstrap.Modal(document.getElementById('loginModal'),{backdrop:'static',keyboard:false})
  if(!token) loginModal.show(); else listNews(1)
})

async function login(){
  const res=await fetch(`${BASE_URL}/user/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:email.value,password:password.value})})
  const data=await res.json()
  if(data.token){token=data.token;localStorage.setItem("jwt_token",token);bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();listNews(1)}else alert("Login gagal")
}

async function listNews(page=1){
  const res=await fetch(`${BASE_URL}/news/list/${page}`,{headers:{"Authorization":`Bearer ${token}`}})
  const result=await res.json()
  const container=document.getElementById("news-list")
  container.innerHTML=""
  result.data.forEach(news=>{
    const div=document.createElement("div")
    div.className="news-card border p-2 mb-2"
    div.innerHTML=`
      <img src="${news.image_url}" alt="${news.title}" class="news-thumb">
      <div>
        <h5 class="mb-1">${news.title}</h5>
        <p class="text-muted mb-2">Tags: ${news.tags} Â· Published: ${news.published_at}</p>
        <div class="d-flex gap-2">
          <button class="btn btn-warning btn-sm" onclick="openEditModal(${news.id}, '${news.slug}')">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteNews(${news.id})">Hapus</button>
        </div>
      </div>
    `
    container.appendChild(div)
  })
  const paginationDiv=document.getElementById("pagination")
  paginationDiv.innerHTML=""
  for(let i=1;i<=result.pagination.total_pages;i++){
    const btn=document.createElement("button")
    btn.className=`btn ${i===result.pagination.current_page?'btn-primary':'btn-outline-primary'} me-1 mb-1`
    btn.textContent=i
    btn.onclick=()=>listNews(i)
    paginationDiv.appendChild(btn)
  }
}

async function createNews(){
  if(!token) return alert("Login dulu")
  await fetch(`${BASE_URL}/news/create`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},body:JSON.stringify({title:title.value,content:CKEDITOR.instances['content'].getData(),tags:tags.value,image_url:image_url.value})})
  alert("Berita ditambahkan")
  listNews(1)
}

async function openEditModal(id,slug){
  editingId=id
  const res=await fetch(`${BASE_URL}/news/detail/${slug}`,{headers:{"Authorization":`Bearer ${token}`}})
  const detail=(await res.json()).data
  edit_title.value=detail.title
  CKEDITOR.instances['edit_content'].setData(detail.content||"")
  edit_tags.value=detail.tags||""
  edit_image_url.value=detail.image_url||""
  new bootstrap.Modal(document.getElementById('editModal')).show()
}

async function saveEdit(){
  await fetch(`${BASE_URL}/news/update/${editingId}`,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},body:JSON.stringify({title:edit_title.value,content:CKEDITOR.instances['edit_content'].getData(),tags:edit_tags.value,image_url:edit_image_url.value})})
  bootstrap.Modal.getInstance(document.getElementById('editModal')).hide()
  alert("Berita diupdate")
  listNews(1)
}

async function deleteNews(id){
  await fetch(`${BASE_URL}/news/delete/${id}`,{method:"DELETE",headers:{"Authorization":`Bearer ${token}`}})
  alert("Berita dihapus")
  listNews(1)
}
</script>
</body>
</html>
